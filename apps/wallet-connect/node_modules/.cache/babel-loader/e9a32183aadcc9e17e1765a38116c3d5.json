{"ast":null,"code":"\"use strict\";\n\nvar __createBinding = this && this.__createBinding || (Object.create ? function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  Object.defineProperty(o, k2, {\n    enumerable: true,\n    get: function () {\n      return m[k];\n    }\n  });\n} : function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  o[k2] = m[k];\n});\n\nvar __exportStar = this && this.__exportStar || function (m, exports) {\n  for (var p in m) if (p !== \"default\" && !Object.prototype.hasOwnProperty.call(exports, p)) __createBinding(exports, m, p);\n};\n\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nconst semver_1 = __importDefault(require(\"semver\"));\n\nconst messageFormatter_1 = require(\"./messageFormatter\");\n\nclass PostMessageCommunicator {\n  constructor(allowedOrigins = null) {\n    this.allowedOrigins = null;\n    this.callbacks = new Map();\n\n    this.isValidMessage = ({\n      origin,\n      data,\n      source\n    }) => {\n      const emptyOrMalformed = !data;\n      const sentFromParentEl = source === window.parent;\n      const allowedSDKVersion = typeof data.version !== 'undefined' ? semver_1.default.gte(data.version, '1.0.0') : false;\n      let validOrigin = true;\n\n      if (Array.isArray(this.allowedOrigins)) {\n        validOrigin = this.allowedOrigins.find(regExp => regExp.test(origin)) !== undefined;\n      }\n\n      return !emptyOrMalformed && sentFromParentEl && allowedSDKVersion && validOrigin;\n    };\n\n    this.logIncomingMessage = msg => {\n      console.info(`Safe Apps SDK v1: A message was received from origin ${msg.origin}. `, msg.data);\n    };\n\n    this.onParentMessage = msg => {\n      if (this.isValidMessage(msg)) {\n        this.logIncomingMessage(msg);\n        this.handleIncomingMessage(msg.data);\n      }\n    };\n\n    this.handleIncomingMessage = payload => {\n      const {\n        id\n      } = payload;\n      const cb = this.callbacks.get(id);\n\n      if (cb) {\n        cb(payload);\n        this.callbacks.delete(id);\n      }\n    };\n\n    this.send = (method, params) => {\n      const request = messageFormatter_1.MessageFormatter.makeRequest(method, params);\n\n      if (typeof window === 'undefined') {\n        throw new Error(\"Window doesn't exist\");\n      }\n\n      window.parent.postMessage(request, '*');\n      return new Promise(resolve => {\n        this.callbacks.set(request.id, response => {\n          resolve(response);\n        });\n      });\n    };\n\n    this.allowedOrigins = allowedOrigins;\n    window.addEventListener('message', this.onParentMessage);\n  }\n\n}\n\nexports.default = PostMessageCommunicator;\n\n__exportStar(require(\"./methods\"), exports);","map":{"version":3,"sources":["../../../src/communication/index.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,MAAA,QAAA,GAAA,eAAA,CAAA,OAAA,CAAA,QAAA,CAAA,CAAA;;AAEA,MAAA,kBAAA,GAAA,OAAA,CAAA,oBAAA,CAAA;;AAKA,MAAM,uBAAN,CAA6B;AAI3B,EAAA,WAAA,CAAY,cAAA,GAAkC,IAA9C,EAAkD;AAHjC,SAAA,cAAA,GAAkC,IAAlC;AACT,SAAA,SAAA,GAAY,IAAI,GAAJ,EAAZ;;AAQA,SAAA,cAAA,GAAiB,CAAC;AAAE,MAAA,MAAF;AAAU,MAAA,IAAV;AAAgB,MAAA;AAAhB,KAAD,KAA6D;AACpF,YAAM,gBAAgB,GAAG,CAAC,IAA1B;AACA,YAAM,gBAAgB,GAAG,MAAM,KAAK,MAAM,CAAC,MAA3C;AACA,YAAM,iBAAiB,GAAG,OAAO,IAAI,CAAC,OAAZ,KAAwB,WAAxB,GAAsC,QAAA,CAAA,OAAA,CAAO,GAAP,CAAW,IAAI,CAAC,OAAhB,EAAyB,OAAzB,CAAtC,GAA0E,KAApG;AACA,UAAI,WAAW,GAAG,IAAlB;;AACA,UAAI,KAAK,CAAC,OAAN,CAAc,KAAK,cAAnB,CAAJ,EAAwC;AACtC,QAAA,WAAW,GAAG,KAAK,cAAL,CAAoB,IAApB,CAA0B,MAAD,IAAY,MAAM,CAAC,IAAP,CAAY,MAAZ,CAArC,MAA8D,SAA5E;AACD;;AAED,aAAO,CAAC,gBAAD,IAAqB,gBAArB,IAAyC,iBAAzC,IAA8D,WAArE;AACD,KAVO;;AAYA,SAAA,kBAAA,GAAsB,GAAD,IAAqC;AAChE,MAAA,OAAO,CAAC,IAAR,CAAa,wDAAwD,GAAG,CAAC,MAAM,IAA/E,EAAqF,GAAG,CAAC,IAAzF;AACD,KAFO;;AAIA,SAAA,eAAA,GAAmB,GAAD,IAAqC;AAC7D,UAAI,KAAK,cAAL,CAAoB,GAApB,CAAJ,EAA8B;AAC5B,aAAK,kBAAL,CAAwB,GAAxB;AACA,aAAK,qBAAL,CAA2B,GAAG,CAAC,IAA/B;AACD;AACF,KALO;;AAOA,SAAA,qBAAA,GAAyB,OAAD,IAAiD;AAC/E,YAAM;AAAE,QAAA;AAAF,UAAS,OAAf;AAEA,YAAM,EAAE,GAAG,KAAK,SAAL,CAAe,GAAf,CAAmB,EAAnB,CAAX;;AACA,UAAI,EAAJ,EAAQ;AACN,QAAA,EAAE,CAAC,OAAD,CAAF;AAEA,aAAK,SAAL,CAAe,MAAf,CAAsB,EAAtB;AACD;AACF,KATO;;AAWD,SAAA,IAAA,GAAO,CAA0B,MAA1B,EAAqC,MAArC,KAAwE;AACpF,YAAM,OAAO,GAAG,kBAAA,CAAA,gBAAA,CAAiB,WAAjB,CAA6B,MAA7B,EAAqC,MAArC,CAAhB;;AAEA,UAAI,OAAO,MAAP,KAAkB,WAAtB,EAAmC;AACjC,cAAM,IAAI,KAAJ,CAAU,sBAAV,CAAN;AACD;;AAED,MAAA,MAAM,CAAC,MAAP,CAAc,WAAd,CAA0B,OAA1B,EAAmC,GAAnC;AACA,aAAO,IAAI,OAAJ,CAAa,OAAD,IAAY;AAC7B,aAAK,SAAL,CAAe,GAAf,CAAmB,OAAO,CAAC,EAA3B,EAAgC,QAAD,IAA0B;AACvD,UAAA,OAAO,CAAC,QAAD,CAAP;AACD,SAFD;AAGD,OAJM,CAAP;AAKD,KAbM;;AAvCL,SAAK,cAAL,GAAsB,cAAtB;AAEA,IAAA,MAAM,CAAC,gBAAP,CAAwB,SAAxB,EAAmC,KAAK,eAAxC;AACD;;AAR0B;;AA4D7B,OAAA,CAAA,OAAA,GAAe,uBAAf;;AACA,YAAA,CAAA,OAAA,CAAA,WAAA,CAAA,EAAA,OAAA,CAAA","sourceRoot":"","sourcesContent":["\"use strict\";\nvar __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });\n}) : (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    o[k2] = m[k];\n}));\nvar __exportStar = (this && this.__exportStar) || function(m, exports) {\n    for (var p in m) if (p !== \"default\" && !Object.prototype.hasOwnProperty.call(exports, p)) __createBinding(exports, m, p);\n};\nvar __importDefault = (this && this.__importDefault) || function (mod) {\n    return (mod && mod.__esModule) ? mod : { \"default\": mod };\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nconst semver_1 = __importDefault(require(\"semver\"));\nconst messageFormatter_1 = require(\"./messageFormatter\");\nclass PostMessageCommunicator {\n    constructor(allowedOrigins = null) {\n        this.allowedOrigins = null;\n        this.callbacks = new Map();\n        this.isValidMessage = ({ origin, data, source }) => {\n            const emptyOrMalformed = !data;\n            const sentFromParentEl = source === window.parent;\n            const allowedSDKVersion = typeof data.version !== 'undefined' ? semver_1.default.gte(data.version, '1.0.0') : false;\n            let validOrigin = true;\n            if (Array.isArray(this.allowedOrigins)) {\n                validOrigin = this.allowedOrigins.find((regExp) => regExp.test(origin)) !== undefined;\n            }\n            return !emptyOrMalformed && sentFromParentEl && allowedSDKVersion && validOrigin;\n        };\n        this.logIncomingMessage = (msg) => {\n            console.info(`Safe Apps SDK v1: A message was received from origin ${msg.origin}. `, msg.data);\n        };\n        this.onParentMessage = (msg) => {\n            if (this.isValidMessage(msg)) {\n                this.logIncomingMessage(msg);\n                this.handleIncomingMessage(msg.data);\n            }\n        };\n        this.handleIncomingMessage = (payload) => {\n            const { id } = payload;\n            const cb = this.callbacks.get(id);\n            if (cb) {\n                cb(payload);\n                this.callbacks.delete(id);\n            }\n        };\n        this.send = (method, params) => {\n            const request = messageFormatter_1.MessageFormatter.makeRequest(method, params);\n            if (typeof window === 'undefined') {\n                throw new Error(\"Window doesn't exist\");\n            }\n            window.parent.postMessage(request, '*');\n            return new Promise((resolve) => {\n                this.callbacks.set(request.id, (response) => {\n                    resolve(response);\n                });\n            });\n        };\n        this.allowedOrigins = allowedOrigins;\n        window.addEventListener('message', this.onParentMessage);\n    }\n}\nexports.default = PostMessageCommunicator;\n__exportStar(require(\"./methods\"), exports);\n//# sourceMappingURL=index.js.map"]},"metadata":{},"sourceType":"script"}